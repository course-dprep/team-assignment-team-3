######################
# Analysing the Data #
######################

# Create directory for output generated by analysis #
dir.create('../../gen/output', recursive = T)

# Load libraries 
library(ggplot2)
library(ggpubr)
library(dplyr)


# INPUT: Load the two final data set: one using host_id level (combined_data1.csv), one using aggregated state level(df_grouped.csv). 
combined_data1 <- read.csv("../../gen/temp/combined_data1.csv")
df_grouped <- read.csv("../../gen/temp/df_grouped.csv")


# Assumptions (normality and outliers)
set.seed(5000)
combined_data_sample <- rnorm(5000)
shapiro.test(combined_data_sample)

price_boxplot <- ggboxplot(combined_data1, x="time", y="price",
                                         color="time", palette = c("#00AFBB", "#E7B800"),
                                         ylab= "Price", xlab="time")
price_boxplot


# Descriptive results
level1 <- combined_data1 %>%
  group_by(category1, time) %>%
  summarise(avg_price = mean(price))
level1 

level2 <- df_grouped %>%
  group_by(category1, time) %>%
  summarise(avg_price1 = mean(avg_price))
level2

#########################
# host_id level analysis#
#########################
# Create an interaction between time and category1. We will call this interaction 'did'
combined_data1$did <- combined_data1$time * combined_data1$category1


# Estimate the DID estimator
didreg = lm(price ~ category1 + time + did, data = combined_data1)
summary(didreg)

# Estimate the DID estimator
didreg1 = lm(price ~ category1*time, data = combined_data1)
summary(didreg1)

##################################
# aggregated state level analysis#
##################################
# Create an interaction between time and category1. We will call this interaction 'did'
df_grouped$did <- df_grouped$time * df_grouped$category1

# Estimate the DID estimator
didreg2 = lm(avg_price ~ category1 + time + did, data = df_grouped)
summary(didreg2)

# Estimate the DID estimator
didreg3 = lm(avg_price ~ category1*time, data = df_grouped)
summary(didreg3)




# Visualiazation 
plot_price <- ggplot(level1, aes(x = as.factor(time), 
                          y = avg_price, 
                          color = as.factor(category1))) + 
  geom_point() +
  geom_line(aes(group = as.factor(category1))) 


plot_price1 <- ggplot(level2, aes(x = as.factor(time), 
                           y = avg_price1, 
                           color = as.factor(category1))) + 
  geom_point() +
  geom_line(aes(group = as.factor(category1))) 



# OUTPUT 
ggsave(plot = price_boxplot, filename = "../../gen/output/price_boxplot.pdf")
ggsave(plot = plot_price, filename = "../../gen/output/plot_price.pdf")
ggsave(plot = plot_price1, filename = "../../gen/output/plot_price1.pdf")



